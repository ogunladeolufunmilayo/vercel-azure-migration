trigger:
  branches:
    include:
      - main
  paths:
    include:
      - infra/*

pool:
  vmImage: ubuntu-latest

variables:
  terraformVersion: "1.7.5"
  workingDirectory: "infra"

stages:
- stage: Terraform
  displayName: "Terraform Plan & Apply"
  jobs:
  - job: Apply
    displayName: "Plan and Apply"
    steps:
    - checkout: self

    - task: AzureCLI@2
      displayName: "Terraform init/plan/apply (OIDC/SPN auth)"
      inputs:
        azureSubscription: "azure-conn"
        scriptType: bash
        scriptLocation: inlineScript

        # ‚≠ê KEY LINE: exposes SPN/WIF details to the script environment
        addSpnToEnvironment: true

        inlineScript: |
          set -euo pipefail

          echo "Installing Terraform $(terraformVersion)..."
          curl -sSL -o terraform.zip "https://releases.hashicorp.com/terraform/$(terraformVersion)/terraform_$(terraformVersion)_linux_amd64.zip"
          sudo unzip -o terraform.zip -d /usr/local/bin
          terraform -version

          cd "$(workingDirectory)"

          # ---- Terraform auth: use Workload Identity (OIDC) or fallback to SP secret if present ----
          export ARM_CLIENT_ID="${servicePrincipalId}"
          export ARM_TENANT_ID="${tenantId}"
          export ARM_SUBSCRIPTION_ID="${subscriptionId}"

          if [[ -n "${AZURE_FEDERATED_TOKEN_FILE:-}" && -f "${AZURE_FEDERATED_TOKEN_FILE}" ]]; then
            echo "Using OIDC federated token for Terraform auth..."
            export ARM_USE_OIDC=true
            export ARM_OIDC_TOKEN="$(cat "$AZURE_FEDERATED_TOKEN_FILE")"
          elif [[ -n "${servicePrincipalKey:-}" ]]; then
            echo "Using client secret for Terraform auth..."
            export ARM_CLIENT_SECRET="${servicePrincipalKey}"
          else
            echo "ERROR: No federated token file and no client secret available."
            exit 1
          fi

          echo "Terraform init..."
          terraform init -input=false

          echo "Terraform validate..."
          terraform validate

          echo "Terraform plan..."
          terraform plan -out=tfplan -input=false

          echo "Terraform apply..."
          terraform apply -auto-approve -input=false tfplan
