trigger:
  branches:
    include:
      - main
  paths:
    exclude:
      - infra/*

pool:
  vmImage: ubuntu-latest

variables:
  NODE_VERSION: "20.x"
  AZURE_SUBSCRIPTION: "azure-conn-sp"
  RG_NAME: "rg-vercel-azure-migration"
  APP_NAME: "vercel-azure-mig-web"
  KEY_VAULT_NAME: "vercel-azure-mig-kv"
  ARTIFACT_NAME: "drop"

stages:
- stage: Build
  displayName: Build
  jobs:
  - job: build
    displayName: Build Next.js
    steps:
    - checkout: self

    - task: NodeTool@0
      inputs:
        versionSpec: "$(NODE_VERSION)"

    - script: |
        npm ci
      displayName: Install dependencies

    - script: |
        npm run build
      displayName: Build

    - script: |
        mkdir -p "$(Build.ArtifactStagingDirectory)"
        zip -r "$(Build.ArtifactStagingDirectory)/app.zip" . \
          -x "**/.git/**" "**/node_modules/**" "**/.next/cache/**" "**/.vercel/**" "**/infra/**"
      displayName: Package app

    - task: PublishBuildArtifacts@1
      inputs:
        PathtoPublish: "$(Build.ArtifactStagingDirectory)/app.zip"
        ArtifactName: "$(ARTIFACT_NAME)"

- stage: Deploy
  displayName: Deploy
  dependsOn: Build
  jobs:
  - job: deploy
    displayName: Deploy to App Service
    steps:
    - download: current
      artifact: "$(ARTIFACT_NAME)"

    - task: AzureCLI@2
      displayName: Configure DATABASE_URL from Key Vault
      inputs:
        azureSubscription: "$(AZURE_SUBSCRIPTION)"
        scriptType: bash
        scriptLocation: inlineScript
        inlineScript: |
          SECRET_URI=$(az keyvault secret show \
            --vault-name "$(KEY_VAULT_NAME)" \
            --name "DATABASE-URL" \
            --query id -o tsv)

          az webapp config appsettings set \
            --resource-group "$(RG_NAME)" \
            --name "$(APP_NAME)" \
            --settings DATABASE_URL="@Microsoft.KeyVault(SecretUri=$SECRET_URI)"

    - task: AzureWebApp@1
      displayName: Deploy app
      inputs:
        azureSubscription: "$(AZURE_SUBSCRIPTION)"
        appType: webAppLinux
        appName: "$(APP_NAME)"
        package: "$(Pipeline.Workspace)/$(ARTIFACT_NAME)/app.zip"

    - task: AzureCLI@2
      displayName: Restart App Service
      inputs:
        azureSubscription: "$(AZURE_SUBSCRIPTION)"
        scriptType: bash
        scriptLocation: inlineScript
        inlineScript: |
          az webapp restart -g "$(RG_NAME)" -n "$(APP_NAME)"