trigger:
  branches:
    include:
      - main
  paths:
    exclude:
      - infra/*

pool:
  vmImage: ubuntu-latest

variables:
  NODE_VERSION: "20.x"
  TF_WORKING_DIR: "infra"

  # Service connection (SP secret)
  AZURE_SUBSCRIPTION: "azure-conn-sp"

  # Your actual resources
  RG_NAME: "rg-vercel-azure-migration"
  WEBAPP_NAME: "vercel-azure-mig-web"
  KEYVAULT_NAME: "vercel-azure-mig-kv"

  ARTIFACT_NAME: "drop"

stages:
- stage: Build
  displayName: Build
  jobs:
  - job: build
    displayName: Build Next.js
    steps:
    - checkout: self

    - task: NodeTool@0
      displayName: "Use Node $(NODE_VERSION)"
      inputs:
        versionSpec: "$(NODE_VERSION)"

    - script: |
        set -euo pipefail
        npm ci
      displayName: Install dependencies

    - script: |
        set -euo pipefail
        npm run build
      displayName: Build app

    # Package everything needed for App Service deployment
    - script: |
        set -euo pipefail
        mkdir -p "$(Build.ArtifactStagingDirectory)"
        zip -r "$(Build.ArtifactStagingDirectory)/app.zip" . \
          -x "**/.git/**" \
             "**/infra/**" \
             "**/.vercel/**" \
             "**/node_modules/**" \
             "**/.next/cache/**"
      displayName: Create deployment zip

    # Publish as PIPELINE artifact (not legacy build artifact)
    - task: PublishPipelineArtifact@1
      displayName: Publish pipeline artifact
      inputs:
        targetPath: "$(Build.ArtifactStagingDirectory)/app.zip"
        artifact: "$(ARTIFACT_NAME)"

- stage: Deploy
  displayName: Deploy
  dependsOn: Build
  jobs:
  - job: deploy
    displayName: Deploy to Azure App Service
    steps:
    - checkout: none

    # Download PIPELINE artifact
    - task: DownloadPipelineArtifact@2
      displayName: Download artifact
      inputs:
        artifact: "$(ARTIFACT_NAME)"
        path: "$(Pipeline.Workspace)"

    # Set DATABASE_URL using Key Vault reference
    - task: AzureCLI@2
      displayName: Set DATABASE_URL via Key Vault reference
      inputs:
        azureSubscription: "$(AZURE_SUBSCRIPTION)"
        scriptType: bash
        scriptLocation: inlineScript
        inlineScript: |
          set -euo pipefail

          echo "Fetching secret URI from Key Vault..."
          SECRET_URI=$(az keyvault secret show \
            --vault-name "$(KEYVAULT_NAME)" \
            --name "DATABASE-URL" \
            --query id -o tsv)

          echo "Setting App Setting DATABASE_URL as Key Vault reference..."
          az webapp config appsettings set \
            --resource-group "$(RG_NAME)" \
            --name "$(WEBAPP_NAME)" \
            --settings DATABASE_URL="@Microsoft.KeyVault(SecretUri=$SECRET_URI)"

          echo "Done."

    # Deploy the zip to App Service (Linux)
    - task: AzureWebApp@1
      displayName: Deploy to Web App
      inputs:
        azureSubscription: "$(AZURE_SUBSCRIPTION)"
        appType: webAppLinux
        appName: "$(WEBAPP_NAME)"
        package: "$(Pipeline.Workspace)/app.zip"

    - task: AzureCLI@2
      displayName: Restart Web App
      inputs:
        azureSubscription: "$(AZURE_SUBSCRIPTION)"
        scriptType: bash
        scriptLocation: inlineScript
        inlineScript: |
          set -euo pipefail
          az webapp restart -g "$(RG_NAME)" -n "$(WEBAPP_NAME)"