trigger:
  branches:
    include:
      - main
  paths:
    include:
      - infra/*

pool:
  vmImage: ubuntu-latest

variables:
  TF_WORKING_DIR: infra

stages:
- stage: Terraform
  displayName: Terraform Plan + Apply
  jobs:
  - job: Deploy
    displayName: Deploy Infrastructure
    steps:
    - checkout: self

    - task: AzureCLI@2
      displayName: Terraform init/plan/apply (SP SECRET)
      inputs:
        azureSubscription: azure-conn-sp
        scriptType: bash
        scriptLocation: inlineScript
        addSpnToEnvironment: true
        inlineScript: |
          set -euo pipefail

          echo "Authenticating Terraform with Service Principal"

          export ARM_CLIENT_ID="$servicePrincipalId"
          export ARM_CLIENT_SECRET="$servicePrincipalKey"
          export ARM_TENANT_ID="$tenantId"
          export ARM_SUBSCRIPTION_ID="$(az account show --query id -o tsv)"

          export TF_VAR_database_url="$(database_url)"

          cd infra

          terraform init -input=false
          terraform validate
          terraform plan -out=tfplan -input=false
          terraform apply -auto-approve -input=false tfplan