trigger:
  branches:
    include:
      - main
  paths:
    include:
      - infra/*

pool:
  vmImage: ubuntu-latest

variables:
  terraformVersion: "1.7.5"   # safe/stable
  workingDirectory: "infra"

stages:
- stage: Terraform
  displayName: "Terraform Plan & Apply"
  jobs:
  - job: Apply
    displayName: "Plan and Apply"
    steps:
    - checkout: self

    - task: AzureCLI@2
      displayName: "Terraform init/plan/apply"
      inputs:
        azureSubscription: "azure-conn"
        scriptType: bash
        scriptLocation: inlineScript
        inlineScript: |
          set -euo pipefail

          echo "Installing Terraform $(terraformVersion)..."
          curl -sSL -o terraform.zip "https://releases.hashicorp.com/terraform/$(terraformVersion)/terraform_$(terraformVersion)_linux_amd64.zip"
          sudo unzip -o terraform.zip -d /usr/local/bin
          terraform -version

          cd "$(workingDirectory)"

          echo "Terraform init..."
          terraform init -input=false

          echo "Terraform validate..."
          terraform validate

          echo "Terraform plan..."
          terraform plan -out=tfplan -input=false

          echo "Terraform apply..."
          terraform apply -auto-approve -input=false tfplan
