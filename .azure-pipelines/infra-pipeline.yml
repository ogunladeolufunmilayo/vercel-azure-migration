trigger:
  branches:
    include:
      - main
  paths:
    include:
      - infra/**

pool:
  vmImage: ubuntu-latest

variables:
  TF_WORKING_DIR: infra
  TF_VERSION: "1.7.5"

stages:
- stage: Terraform
  displayName: Terraform Plan + Apply
  jobs:
  - job: terraform
    displayName: Terraform
    steps:
    - checkout: self

    - task: AzureCLI@2
      displayName: Terraform init/plan/apply (SP Secret)
      inputs:
        azureSubscription: azure-conn-sp
        scriptType: bash
        scriptLocation: inlineScript
        addSpnToEnvironment: true
        inlineScript: |
          set -euo pipefail

          echo "Installing Terraform ${TF_VERSION}..."
          curl -sSL -o terraform.zip "https://releases.hashicorp.com/terraform/${TF_VERSION}/terraform_${TF_VERSION}_linux_amd64.zip"
          sudo unzip -o terraform.zip -d /usr/local/bin
          terraform -version

          # Force Terraform to authenticate with the Service Principal SECRET
          export ARM_CLIENT_ID="$servicePrincipalId"
          export ARM_CLIENT_SECRET="$servicePrincipalKey"
          export ARM_TENANT_ID="$tenantId"
          export ARM_SUBSCRIPTION_ID="$(az account show --query id -o tsv)"

          cd "$(TF_WORKING_DIR)"

          terraform init
          terraform validate
          terraform plan -out=tfplan
          terraform apply -auto-approve tfplan